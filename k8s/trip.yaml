apiVersion: apps/v1
kind: Deployment
metadata:
  name: trip-service
  namespace: trip
spec:
  replicas: 1
  selector:
    matchLabels:
      app: trip-service
  template:
    metadata:
      labels:
        app: trip-service
    spec:
      containers:
        - name: trip-service
          image: trip-service:1.0
          imagePullPolicy: IfNotPresent
          # Run a tolerant DB bootstrap, then start the API
          command: ["bash","-lc"]
          args:
            - >
              echo "[trip] running check_db.py (non-fatal)..." &&
              python /app/check_db.py || echo "[trip] check_db.py failed (continuing)" ;
              echo "[trip] starting uvicorn..." &&
              exec uvicorn app.main:app --host 0.0.0.0 --port 8000
          ports:
            - containerPort: 8000
          env:
            - name: PYTHONUNBUFFERED
              valueFrom:
                configMapKeyRef:
                  name: trip-config
                  key: PYTHONUNBUFFERED

            # Real services on your Windows host, via Minikube's host gateway
            - name: PAYMENT_URL
              valueFrom:
                configMapKeyRef:
                  name: trip-config
                  key: PAYMENT_URL
            - name: DRIVER_URL
              valueFrom:
                configMapKeyRef:
                  name: trip-config
                  key: DRIVER_URL
            - name: RIDER_URL
              valueFrom:
                configMapKeyRef:
                  name: trip-config
                  key: RIDER_URL

            # Database URL
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: trip-secrets
                  key: DATABASE_URL

          readinessProbe:
            httpGet:
              path: /health
              port: 8000
            initialDelaySeconds: 5
            periodSeconds: 5
          livenessProbe:
            httpGet:
              path: /health
              port: 8000
            initialDelaySeconds: 10
            periodSeconds: 10
          startupProbe:
            httpGet:
              path: /health
              port: 8000
            initialDelaySeconds: 10
            periodSeconds: 5
            failureThreshold: 12
---
apiVersion: v1
kind: Service
metadata:
  name: trip-service
  namespace: trip
spec:
  selector:
    app: trip-service
  ports:
    - name: http
      port: 8000
      targetPort: 8000
      nodePort: 30084
  type: NodePort
